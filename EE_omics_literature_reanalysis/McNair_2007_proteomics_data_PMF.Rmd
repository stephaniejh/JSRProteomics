---
title: "2025_28_11_McNair_2007"
author: "Stephanie Huang"
date: "`r Sys.Date()`"
output: html_document
---

## PMF Table Clean up & Plotting of McNair 2007

Rat Peptide Mass Fingerprinting (2DIGE splot pick + MALDI - also LCMSMS for unresolved but not clear which were later ID'd by tandem ms).

-   Adolescent/Young Adult Hooded Lister Male Rats (8 weeks) in an overnight playpen style EE paradigm for 6 weeks.

-   Split Hippocampus CA1Somatic & Dendritic Fractions

    -   Mostly Somatic Fraction is the stratum pyramidale

    -   Dendritic Fraction is the stratum radiatum

*in Neuroscience - "*Global changes in the hippocampal proteome following exposure to an enriched environment*" https://doi.org/10.1016/j.neuroscience.2006.12.033*

Analysis originally done in R_WD \> Proteomics \> EE_TMT \> v3_branched on 2025_11_28

Previous title 2025_28_11_McNair_2007_proteomics_data_PMF.Rmd

***NOTE TO SELF - TO DO - find gi acccession conversions to get gene ids*** \| + add names for class abbreviations.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load Packages

```{r}
library(readr)
library(readxl)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(gt)
```

### Load Tables 
```{r}
raw_som <- read_excel("input/McNair_2007_proteomics_table_raw.xlsx",
                      sheet = "1_somatic_fraction_raw")

raw_den <- read_excel("input/McNair_2007_proteomics_table_raw.xlsx",
                      sheet = "2_dendritic_fraction_raw")

```

## Clean up tables

### Bind both tables
```{r}
# make combined raw file with both fractions
com_raw <- bind_rows(list(Somatic = raw_som, Dendritic = raw_den),
                     .id = "Fraction")
```

```{r}
colnames(com_raw)
```


### Remove rows with empty protein IDs & rows with now Mowse Score/NCBI Accession No. etc
NOTE TO SELF - look into this further! Pretty sure these are the missing unidenfitified spots but not 100% sure - double check 

1.  Remove anything with no protein ID or NCBI ID or Mowse score (so spots observed but no protein match?)

2.  Due to 1 spot having multiple proteins (sometimes) use tidyr fill function to fill with value above.

    1.  This done by 1st filling by spot number <https://tidyr.tidyverse.org/reference/fill.html>

3.  Next, group by spot number & use fill on fold change & p value & fill with "downup"

    1.  e.g. whatever present value in that group use to fill.

    2.  This is probably a bit extra, but it is the safer option in case there are some weird rows.

```{r}

com_fil <- com_raw %>% 
  filter(!is.na(`Protein ID`)) %>%   # goes from 132 obs to 108 obs
  filter(!is.na(`Mowse Score`)) %>%   # incl class & NCBI cols| now 105 obs
  fill(`Spot no.`, .direction = "down") %>%
  group_by(`Spot no.`) %>%
  fill(c(`Av. Ratio`,`Control vs. enriched (t-test)`),
       .direction = "downup") 

# write out? or combine with below into 1?
```


### Fix weird dash, convert to numeric, & add direction of fold change column. 
-   weird dash - print w tail() to get observation

    -   weird dash is − while normal one is (hyphen) -

    -   once replaced with -, should let you convert to numeric & properly recognize & then make direction column as \>0 = Up

    -   <https://stringr.tidyverse.org/reference/str_replace.html>

```{r}
# fix weird dashes & make numeric + add direction col
# tail(com_fil)

com_df <- com_fil %>%
  # NEW CODE | keep old col just to be safe
  mutate(avg_ratio = str_replace(`Av. Ratio`, "−", "-"),  #old,new
         .after = `Av. Ratio`) %>% 
  mutate(avg_ratio = round(as.numeric(avg_ratio),2)) %>% 
  mutate(Direction = ifelse(avg_ratio > 0, "Up", "Down"),
         .after = "avg_ratio")
  
```


#### Write out data frame
```{r}
#write_csv(com_df, "output/2025_28_11_McNair2007_data_cleaned_v1.csv")
```

## Plots
### Barplots
-   geom_bar vs geom_col - <https://r-charts.com/ranking/bar-plot-ggplot2/>

    -   geom_bar counts occurences! Then: position = position_dodge(preserve = 'single', width=1) - keeps width for bars the same!

    -   polar coordinates pie bar - looks cool but not the right one - <https://stackoverflow.com/questions/59922719/pie-chart-with-ggplot2-counting-the-occurrences-of-entries>

```{r fig.height=5, fig.width=11}
barplots_1 <- ggplot(com_df,
                 aes(x = Class, fill = Class, alpha = Direction)) +
  geom_bar(position = position_dodge(preserve = 'single', width=0.7),
           width = 0.6, color = "grey10") +
  #coord_polar(theta='y') + # spiral! not the right one but cool looking
  facet_wrap(~ Fraction, ncol = 2) +
  scale_alpha_discrete(range = c(0.3, 0.9)) +
  labs(title = "McNair 2007 - EE Rats - PMF Proteomics - Tables 1 & 2",
      subtitle = "Split by Fraction, Direction by Alpha, Class by Color. Uses trimmed data w blanks removed") +
  theme_bw()


barplots_1
```

```{r}
# by group! 
summed_df <- com_df %>%
  group_by(Fraction) %>%
  count(Class) %>%
  mutate(Percentage = round(n/sum(n) * 100,0))
```

### Base R Pie Charts

```{r}
print(summed_df) # 1- dendritc & 9-19 somatic
```

```{r}
names <- summed_df$Class # make names list from col
```

```{r}
pie(summed_df$n[1:8], labels = names[1:8],
    main = "Dendritic Fraction ()") # dendritic
```

```{r}
pie(summed_df$n[9:19], labels = names[9:19],
    main = "Somatic Fraction") # somatic
```

### ggplot pie charts

-   <https://r-graph-gallery.com/piechart-ggplot2.html>

```{r fig.height=5, fig.width=10}
ggpie <- ggplot(summed_df, 
                aes(x = "", y=Percentage, fill = Class)) +
  geom_bar(stat="identity", width = 1,
           color = "grey10", alpha = 0.5) +
  coord_polar("y", start = 0) +
  geom_text(aes(label = Class), position = position_stack(vjust = .5),
            size = 3.5) +
  facet_wrap(~Fraction) +
  labs(title = "McNair 2007 - Proportion of Class by Fraction") +
  theme_bw()

ggpie
```


## Cleaned up gt table 
-   <https://gt.rstudio.com/>

```{r}
# gt 1 - by fold change direction & pvalue
com_df |> 
  dplyr::select(-(c(`Av. Ratio`, ))) |>
  dplyr::arrange(`Control vs. enriched (t-test)`) |>
  gt(
    groupname_col = "Direction"
  ) |>
    tab_header(
      title = "McNair 2007 - Tables 1 & 2",
      subtitle = "Cleaned data, Organised by Fold Change Direction & Arranged by pvalue"
    ) |>
    tab_options(table.font.size=12)
```
