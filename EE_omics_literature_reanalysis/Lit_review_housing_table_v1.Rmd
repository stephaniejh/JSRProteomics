---
title: "Testing_lit_review_test_read_in_housing_table_v1"
author: "Stephanie Huang"
date: "2025-12-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

To Do: Add Zhang et al., 2020, other rat omics, socodato??? Zocher?

### Load Packages

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(gt)
library(lubridate)
library(ggwordcloud)
library(colorspace) # for scale_color_discrete_divergingx
library(paletteer) # for scale_colour_paletteer_d
# library(MetBrewer) # for colors
library(khroma) # for colors
library(palettesForR) # colors
library(ggtext) # for element_markdown() - (e.g. custom color & font axis labels)
library(glue) # glue() - to prep vars for ggtext mapping
library(cowplot)
library(gg3D) # make ggplots 3D 
library(ggh4x)
```

## Read in data

```{r}
rat_df <- read_excel(
  "input/2026_01_13_EE_omics_lit_review_mRNA_Proteins.xlsx",
                              sheet = "rat_housing") %>%
  mutate(no_per_cage = as.character(no_per_cage)) # so it can bind 


mice_df <- read_excel(
  "input/2026_01_13_EE_omics_lit_review_mRNA_Proteins.xlsx",
                              sheet = "mice_housing") %>%
  mutate(no_per_cage = as.character(no_per_cage))
  


pig_df <- read_excel(
  "input/2026_01_13_EE_omics_lit_review_mRNA_Proteins.xlsx",
                              sheet = "pigs_housing") %>%
  mutate(no_per_cage = as.character(no_per_cage))
```

## Wrangling & Shaping

-   <https://www.spsanderson.com/steveondata/posts/2025-10-20/#addressing-truly-empty-rows-with-rowsums>

```{r}
# colnames(rat_df) # to double check spaces

housing_df_1 <- bind_rows(rat_df, mice_df, pig_df) %>%
  select(!c("...26", "...31", "...36"))  # rm empty columns spaces | 69x37 

housing_df_2 <- housing_df_1[rowSums(is.na(housing_df_1)) != ncol(housing_df_1), ] # rm truly empty rows | x 37  
```

-   split cell into 2 cells - <https://tidyr.tidyverse.org/reference/separate_wider_delim.html>

```{r}
housing_df_3 <- housing_df_2 %>%
  
  # make combined author & year variable
  mutate(author_year = paste0(author, ' ', year), .before = year)  %>%
  
  # split the housing start column into the number & unit
  tidyr::separate_wider_delim(housing_start, delim = " ",
                             names = c("house_start_no", "house_start_unit"),
                             cols_remove = FALSE) %>%
  
  # recode some numbers that are 15-17 or 5-6 or 9-10 & then make numeric
  mutate(house_start_no = as.numeric(recode(house_start_no, # old = "new"
                                   "15-17" = "16",
                                   "5-6" = "5.5",
                                   "9-10" = "9.5"))) %>%
  
  # now calculate as start day (all the same unit)
  mutate(housing_start_day = case_when(
     house_start_unit == "months" ~ 30 * house_start_no,
     house_start_unit == "weeks" ~ 7 * house_start_no,
     house_start_unit == "days" ~ house_start_no
        ), .after = house_start_unit) %>%
  
  
  # now do it for housing duration using the same formula from above!
  tidyr::separate_wider_delim(housing_duration, delim = " ",
                              names = c("house_dur_no", "house_dur_unit"),
                              cols_remove = FALSE) %>%
  mutate(house_dur_no = as.numeric(house_dur_no)) %>%

  mutate(housing_duration_days = case_when(
    house_dur_unit == "M" ~ 30 * house_dur_no,
    house_dur_unit == "W" ~ 7 * house_dur_no,
    house_dur_unit == "d" ~ house_dur_no,
    house_dur_unit == "h" ~ house_dur_no / 24
  ), .after = house_dur_unit) %>%
  
  mutate(housing_stop_day = housing_start_day + housing_duration_days,
         .after = housing_duration_days) %>%
  
  mutate(animal_type = factor(animal_type,
                              levels = c("rat", "mice", "pigs"))) %>%
  mutate(animal_type = recode(animal_type, rat = "rats")) %>%
  


  # CAGE DIMENSIONS
  # split L x W x H cm cage dimensions into 3 columns & make numeric
  tidyr::separate_wider_delim(cage_dim_cm, delim = " x ",
                              names = c("length", "width", "height"),
                              too_few = "align_start", # deals with 2 or NAs
                              cols_remove = FALSE) %>%
  mutate(across(c("length", "width", "height"), as.numeric)) %>%
  
  # recode no_per_cage - e.g deal with 4 max or 5-6
  # use max if 5-6 (spans 1) or mid whole no if 3-5
  mutate(no_per_cage_2 = as.numeric(recode(no_per_cage,
                                           "3-4?" = "4",
                                           "3-5" = "4",
                                           "4 max" = "4", 
                                           "4?" = "4",
                                           "6 max" = "6",
                                           "5-6" = "6")),
         .after = no_per_cage)
  
  
```

```{r}
summary(housing_df_3)
# start - old mean: median 28 days mean 80.35 | new median 28 & mean 73.18
# end - old mean: median 98 days mean 167.5 days | new median 98 & mean 162.8
# duration - old median 42 & median 85.635 | new median 40 & mean 90.287
```

```{r}
EE_only_df <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) # keeps 1 observation per group! 
```

```{r}
# one house + controls & WT only)
one_house_df <- housing_df_3 %>%
  filter(!str_detect(housing_condition,
                     "Stress|Cocaine|TG|Injured|MS|EPN"))  %>%
  group_by(animal_type, author_year, housing) %>%
  slice_head(n=1) %>%
  ungroup()

# always double check after running
unique(one_house_df$housing_condition)
```

```{r}
# IC, SH, & EE
# excludes transgenic, Stress, ELS (MS), Cocaine, Injured & EPN (Pb exposure) etc
# keeps normal + Aging or duration, or saline/PBS, No MS stress (NS), PBS, WT, Intact
WT_ctrl_only <- housing_df_3 %>%
  filter(!str_detect(housing_condition,
                     "Stress|Cocaine|TG|Injured|MS|EPN")) 


# EE ONLY!!! (used for timeline plot!)
# excludes transgenic, Stress, ELS (MS), Cocaine, Injured & EPN (Pb exposure) etc
# keeps EE normal + Aging or duration, or saline/PBS, No MS stress (NS), PBS, WT, Intact
WT_ctrl_EE_only <- housing_df_3 %>%
  filter(!str_detect(housing_condition, "Stress|Cocaine|TG|Injured|MS|EPN")) %>%
  filter(housing == "EE")
```

## Timeline Plot (for housing start/end & duration)

-   <https://stackoverflow.com/questions/45245368/ggplot2-how-to-create-a-clustered-timeline>
    -   <https://ggplot2.tidyverse.org/reference/geom_segment.html> for timeline bits
    -   Actually use geom_rect instead (as it allows fill & color!)
-   <https://colorspace.r-forge.r-project.org/articles/hcl_palettes.html>
    -   <https://pmassicotte.github.io/paletteer_gallery/#continuous-palettes>
    -   Browse colors on web <https://emilhvitfeldt.github.io/r-color-palettes/discrete.html#category=>
-   <https://en.wikipedia.org/wiki/Table_of_divisors>
-   <https://github.com/wilkelab/ggtext> & <https://r-graph-gallery.com/package/ggtext.html> - element_markdown() (using ggtext & glue packages) for specifying custom axis text labels - e.g. pink for females & blue for males.
    -   <https://stackoverflow.com/questions/72749018/color-axis-text-to-match-grouping-variable-in-ggplot>
-   OLD CODE DELETED
    -   geom_segment - y & yend= reorder(interaction(author_year, housing_condition), study_yr_by_dur, decreasing = TRUE),

```{r}
# COLORS
temp_colors <- c("#c90076", "#B9006C","#A80062", "#2986cc", "#125CCC", "#1B5988")
palette_color_dynamic_list <- paletteer::palettes_dynamic_names
palette_color_list <- paletteer::palettes_d_names
```

```{r}
timeline_plot <- WT_ctrl_EE_only %>%
  
  mutate(
  # MAKE appended author_year & housing_cond var (tp avoid using messy interaction())
    author_year_hc = paste0(author_year, " - ", housing_condition), # do i need this??
    
  # ORDERING BY YEAR & HOUSING DURATION! 
    # new composite variable for reorder() function below which only takes 1 var
    # it takes year year & adds a tiny contribution from during duration (dur/1000)
    # that way something with 2011 + 200 days ends up being higher 
    study_yr_by_dur = (year + (housing_duration_days/1000)), 
  
  # COLORING = 
  sex_colors = case_when(
    animal_sex == "female" ~ "#c90076", # female
    animal_sex == "male" ~ "#125CCC",  # male
    .default = "grey15"), # for NA / catch others
  .before = author
  ) %>%

  # COMPUTE VAR for element_markdown() (for custom axis text colors)
  mutate(
    #color = c("#A80062", "#1B5988", "grey15"), # see above instead! 
    # names = glue("<i style='color:{sex_colors}'>{author_year_hc}</i>"), # italics ver
  names = glue("<span style='color:{sex_colors}'>{author_year_hc}</span>"),
  names = reorder(names, study_yr_by_dur, decreasing = TRUE)
         ) %>%
  
  ggplot(aes(color = author)) + 
  
  # LINES for REFERENCE (e.g PND 0, 21, 1 year)
  geom_vline(xintercept = 0, linetype = "solid", # PND 0 line | birth
             color = "grey20", linewidth = .1) +
  # annotate("text", x = 1, y = -Inf, label = "0", 
  #          vjust = -.2, hjust = -.2,
  #          size = 3, color = "grey10") + 
  geom_vline(xintercept = 21, linetype = "dotted", # PND 21 line | weaning
             color = "grey50", linewidth = .1) +
  geom_vline(xintercept = 365, linetype = "dotted", # PND 365 line | 1 year
             color = "grey50", linewidth = .1) +
  
  #TIMELINE SEGMENTS (SOLID LARGE for ANIMAL_TYPE COLOR OUTLINE)
  geom_segment(aes( #SOLID
    x = housing_start_day, # housing start date
    xend = housing_stop_day, # housing end date
    y = names,
    yend = names,
    ), linewidth = 3.5) +

  scale_x_continuous(
    breaks = sort(c(-7, 0, 0, 0, 21, 21, 365, 365, 570, # specific ones i want
                    60, 120, 180, 240, 300, 420, 480, 540)), # eh just do manually
    expand = c(0, 3), # minimal extra white space (0,0 too trimmed)
    name = "Postnatal Day (PND)") + 
  
  scale_color_discrete_qualitative(palette = "Set 2", rev = TRUE) + # colorspace pkg
  # scale_color_paletteer_d("khroma::discreterainbow") +
  # scale_color_paletteer_d("palettesForR::Echo") +


  # FACET
  facet_wrap(#animal_type~animal_sex, 
             ~animal_type,
             # ncol =1,
             scales = "free_y", # don't plot all authors if no obs but x axis same 
             space = "free_y", # varies panel height according to no. authors
             labeller = labeller(
               animal_type = c(rats = "Rats", # capitilise rat = Rats
                             mice = "Mice",
                             pigs = "Pigs/Porcine")), 
             ) +
  # THEME  
  theme_bw() + 
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(), # custom ggtext color by animal_sex,
    axis.text.x = element_text(size = 8, color = "grey10"),
    axis.title.x = element_text(size = 9, color = "grey10"),
    #axis.text.x = element_text(color = "grey15")
    panel.grid = element_line(colour = "grey95")  # lighter 
  )

timeline_plot
#one currently used for thesis - 2026_01_14_EE_timeline_omics_lit_review_v2.pdf
```

------------------------------------------------------------------------

## EE Contents

```{r}
EE_contents <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  mutate(enrichment_contents_split = str_split(enrichment_contents_list, "; "),
         .after = enrichment_contents_list) %>%
  tidyr::unnest(enrichment_contents_split) %>%
  count(enrichment_contents_split) 
```

```{r}
EE_running_wheel <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  count(running_wheel)

knitr::kable(EE_running_wheel) # 16/22 yes |includ Novati Saucer wheel
```

-   <https://cran.r-project.org/web/packages/ggwordcloud/vignettes/ggwordcloud.html>

-   <https://lepennec.github.io/ggwordcloud/>

```{r}
# EE_contents_wordcloud <- EE_contents %>%
ggplot(EE_contents, aes(label = enrichment_contents_split)) +
  geom_text_wordcloud() +
  theme_minimal()
```

-   <https://forum.posit.co/t/case-when-mutate-str-detect/124835>
-   <https://colorspace.r-forge.r-project.org/articles/ggplot2_color_scales.html>

```{r}
EE_contents_reshaped <- housing_df_3 %>%
  
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  group_by(housing) %>%
  mutate(enrichment_contents_split = str_split(
    enrichment_contents_list, ";"),
    .after = enrichment_contents_list) %>%
  
  tidyr::unnest(enrichment_contents_split) %>%
  mutate(contents_split = str_squish(enrichment_contents_split),
         .after = enrichment_contents_split) %>%
  
  mutate(contents_split_rm = str_remove_all(
    contents_split, "\\s*\\(.*?\\)"), # rm between brackets
    .after = contents_split) %>% 
  
  mutate(contents_split_clean = case_when(
    str_detect(contents_split_rm,
      pattern = "running wheel") ~ "running wheels",
    str_detect(contents_split_rm, "tunnel") ~ "tunnels",
    str_detect(contents_split_rm, "ladder") ~ "ladders",
    str_detect(contents_split_rm, "tube") ~ "tubes",
    str_detect(contents_split_rm, "toys") ~ "toys",
    str_detect(contents_split_rm, "ball") ~ "balls",
    str_detect(contents_split_rm, "bedding") ~ "bedding",
    str_detect(contents_split_rm, "house") ~ "house",
    str_detect(contents_split_rm, "shelter") ~ "shelter",
    str_detect(contents_split_rm,
               "wooden blocks") ~ "wooden blocks",
    .default = as.character(contents_split_rm)
  ), .after = contents_split_rm) %>%
  count(contents_split_clean) 

```

```{r}
EE_wordcloud <- ggplot(EE_contents_reshaped,
       aes(label = contents_split_clean,
           size = n)) +
  geom_text_wordcloud() +
  # geom_text_wordcloud_area() +
  # geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 13) +
   facet_wrap(~housing,
             labeller = labeller(
               housing = c(EE = "Environmental Enrichment")),
             strip.position = "bottom") +
  #scale_size_area(max_size = 50) +
  theme_minimal() 


EE_wordcloud
```

```{r}
IC_SH_ontents_reshaped <- housing_df_3 %>%
  filter(housing %in%  c("IC", "SH")) %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  
  mutate(enrichment_contents_split = str_split(
    enrichment_contents_list, ";"),
    .after = enrichment_contents_list) %>%
  
  tidyr::unnest(enrichment_contents_split) %>%
  mutate(contents_split = str_squish(enrichment_contents_split),
         .after = enrichment_contents_split) %>%
  group_by(housing) %>%
  count(contents_split) #

```

```{r}
IC_SH_wordcloud <- ggplot(IC_SH_ontents_reshaped,
       aes(label = contents_split,
           size = n)) +
  geom_text_wordcloud() +
  facet_wrap(~housing, ncol = 2,
             labeller = labeller(
               housing = c(IC = "Isolated Control",
                           SH = "Standard Housing")),
             strip.position = "bottom") +
  # geom_text_wordcloud_area() +
  # geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 13) +
  #scale_size_area(max_size = 50) +
  # theme_minimal()
  theme_minimal() +
  theme(
    # panel.border = element_rect(colour = "grey20", fill=NA, size=0.5),
    # strip.text = element_text(size = 12, face = "italic")
    ) 

IC_SH_wordcloud
```

```{r}
plot_grid(EE_wordcloud,IC_SH_wordcloud, nrow = 2,
          labels = c("a", "b"))

```

## Cage & no. - gg3D

-   <https://htmlpreview.github.io/?https://github.com/AckerDWM/gg3D/blob/master/gg3D-vignette.html>

```{r}
# NOT RIGHT :(
# NEED 2 DUMMY CODE DATA
cage_no_plot <- one_house_df %>%
  # filter(!is.na(length)) %>% # rm those w/ no length (those r all 3 empty)
  filter(!is.na(height)) %>% # rm no 3rd (height), (so full NAs & 2Ds)
  ggplot(aes(x = length,
             y = width,
             z = height,
             color = animal_type)) +
  # geom_segment(aes(x = 0,
  #              xend = length,
  #              y = 0, 
  #              yend = width,
  #              # z = 0, # doesnt exist
  #              # zend = height
  #              ) ) +
  axes_3D(aes(group = interaction(author, housing))) +
  stat_3D() +
  facet_wrap(~author+housing,
             # scales = "free",
             ) +
  # facet_nested(~ author_year + housing,
  #              scales = "free",
  #              space = "free") +
  theme_bw()
  # theme(panel.spacing = )

cage_no_plot
```

```{r}

```

------------------------------------------------------------------------

## Males vs Females Study Count

```{r}
males_females_study <- housing_df_3 %>%
  group_by(author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>%
  count(animal_sex)

knitr::kable(males_females_study)
```

```{r}
animal_types_study <- housing_df_3 %>%
  group_by(author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>%
  count(animal_type)

knitr::kable(animal_types_study)
```

------------------------------------------------------------------------

## Protein vs mRNA

```{r}
protein_mRNA <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>%
  count(h_exp_type)

knitr::kable(protein_mRNA)
```

proteomics

```{r}
proteomics_df <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  mutate(proteomics = ifelse(str_detect(h_method, "Proteomics"),
                             "proteomics",
                             "no proteomics")) %>%
  group_by(proteomics) %>%
  count(animal_type)
```

## 

```{r}

```

------------------------------------------------------------------------

## Region

```{r}
regions_df <- housing_df_3 %>%
  filter(housing == "EE") %>%
  # filter(!author %in% c("Nithianantharajah", "Ickes", "Angelucci")) %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  mutate(split_regions = str_split(h_regions, "; "), .after = h_regions) %>%
  tidyr::unnest(split_regions) %>%
  count(split_regions) %>%
  arrange(desc(n)) %>%
  mutate(total = sum(n)) %>%
  mutate(percent = round(n/total * 100, 1)) %>%
  mutate(percent_by_paper = round(n/23 * 100, 1)) 
  

knitr::kable(regions_df)
# 
```

```{r}
  # # group regions more broadly
  # mutate(cortex_hip = case_when(
  #   str_detect(split_regions, "Cortex") ~ "Cortex",
  #   str_detect(split_regions, "Hippocampus") ~ "Hippocampus",
  #   .default = as.character(split_regions)
  # ), .after = percent_by_paper) 
```

## gt

```{r}
housing_df_3 |> 
  # 
  # dplyr::select(c(animal_type,author_year, housing, animal_strain,
  #                 inbred_outbred, wt_tg, animal_sex,
  #                 cage_description, cage_dim_cm, no_per_cage, 
  #                 enrichment_contents_list, running_wheel,
  #                 procedure)) |>
  # ungroup() |>
  
  gt(
    groupname_col = "animal_type",
    # rowname_col = c("year", "author")
    rowname_col = "author_year"
  ) |>
  
  cols_label(
    # Gene_name = "Entry",
    # Entry.Name = "Name",
    # Full_name = "Protein Description",
    # # misc = "Arroyo's Identifiers"
    # `Protein description` = "Arroyo's Identifiers"
  ) |>
  
  tab_header(
    title = "Test",
    # subtitle = "Enriched vs. Barren: 56 DEG, 46 Up & 10 Down (adjp <=0.05), piggenemapped2ratgene (20 EE pigs & 20 BE pigs)", 
  ) |>
  
  # tab_style( 
  #   style = list(
  #     # cell_fill(color = "#F9E3D6"),
  #     cell_text(style = "italic")
  #     ),
  #   locations = cells_body(
  #     # columns = Gene_name,
  #     # rows = currency < 100
  #   )
  # ) |>
  
  tab_options(heading.title.font.size = 16.5,
              table.font.size=11.5,
              stub.font.weight = "bold",
              # stub.font.size = 13,
              row_group.font.weight = "bold",
              row_group.font.size = 14,
              column_labels.font.size = 12.5,
              column_labels.font.weight = "bold") 
 #|>
  
  # opt_stylize(style = 1, color = 'gray', add_row_striping = TRUE)
```
