---
title: "Testing_lit_review_test_read_in_housing_table_v1"
author: "Stephanie Huang"
date: "2025-12-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

To Do: Add Zhang et al., 2020, other rat omics, socodato??? Zocher?

### Load Packages

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(gt)
library(lubridate)
library(ggwordcloud)
library(colorspace) # for scale_color_discrete_divergingx
library(ggtext) # for element_markdown() - (e.g. custom color & font axis labels)
library(glue) # glue() - to prep vars for ggtext mapping
```

## Read in data

```{r}
rat_df <- read_excel(
  "input/2026_01_13_EE_omics_lit_review_mRNA_Proteins.xlsx",
                              sheet = "rat_housing") %>%
  mutate(no_per_cage = as.character(no_per_cage)) # so it can bind 


mice_df <- read_excel(
  "input/2026_01_13_EE_omics_lit_review_mRNA_Proteins.xlsx",
                              sheet = "mice_housing") %>%
  mutate(no_per_cage = as.character(no_per_cage))
  


pig_df <- read_excel(
  "input/2026_01_13_EE_omics_lit_review_mRNA_Proteins.xlsx",
                              sheet = "pigs_housing") %>%
  mutate(no_per_cage = as.character(no_per_cage))
```

## Wrangling & Shaping

-   <https://www.spsanderson.com/steveondata/posts/2025-10-20/#addressing-truly-empty-rows-with-rowsums>

```{r}
# colnames(rat_df) # to double check spaces

housing_df_1 <- bind_rows(rat_df, mice_df, pig_df) %>%
  select(!c("...26", "...31", "...36"))  # rm empty columns spaces | 69x37 

housing_df_2 <- housing_df_1[rowSums(is.na(housing_df_1)) != ncol(housing_df_1), ] # rm truly empty rows | x 37  
```

-   split cell into 2 cells - <https://tidyr.tidyverse.org/reference/separate_wider_delim.html>

```{r}
housing_df_3 <- housing_df_2 %>%
  
  # make combined author & year variable
  mutate(author_year = paste0(author, ' ', year), .before = year)  %>%
  
  # split the housing start column into the number & unit
  tidyr::separate_wider_delim(housing_start, delim = " ",
                              names = c("house_start_no", "house_start_unit"),
                              cols_remove = FALSE) %>%
  
  # recode some numbers that are 15-17 or 5-6 or 9-10 & then make numeric
  mutate(house_start_no = as.numeric(recode(house_start_no, # old = "new"
                                   "15-17" = "16",
                                   "5-6" = "5.5",
                                   "9-10" = "9.5"))) %>%
  
  # now calculate as start day (all the same unit)
  mutate(housing_start_day = case_when(
     house_start_unit == "months" ~ 30 * house_start_no,
     house_start_unit == "weeks" ~ 7 * house_start_no,
     house_start_unit == "days" ~ house_start_no
        ), .after = house_start_unit) %>%
  
  
  # now do it for housing duration using the same formula from above!
  tidyr::separate_wider_delim(housing_duration, delim = " ",
                              names = c("house_dur_no", "house_dur_unit"),
                              cols_remove = FALSE) %>%
  mutate(house_dur_no = as.numeric(house_dur_no)) %>%

  mutate(housing_duration_days = case_when(
    house_dur_unit == "M" ~ 30 * house_dur_no,
    house_dur_unit == "W" ~ 7 * house_dur_no,
    house_dur_unit == "d" ~ house_dur_no,
    house_dur_unit == "h" ~ house_dur_no / 24
  ), .after = house_dur_unit) %>%
  
  mutate(housing_stop_day = housing_start_day + housing_duration_days,
         .after = housing_duration_days) %>%
  
  mutate(animal_type = factor(animal_type,
                              levels = c("rat", "mice", "pigs"))) %>%
  mutate(animal_type = recode(animal_type, rat = "rats")) #%>%
  
  
  #  mutate(contents_split_clean = case_when(
  #   str_detect(contents_split_rm,
  #     pattern = "running wheel") ~ "running wheels",
  #   str_detect(contents_split_rm, "tunnel") ~ "tunnels",
  #   str_detect(contents_split_rm, "ladder") ~ "ladders",
  #   str_detect(contents_split_rm, "tube") ~ "tubes",
  #   str_detect(contents_split_rm, "toys") ~ "toys",
  #   str_detect(contents_split_rm, "ball") ~ "balls",
  #   str_detect(contents_split_rm, "bedding") ~ "bedding",
  #   str_detect(contents_split_rm, "house") ~ "house",
  #   str_detect(contents_split_rm, "shelter") ~ "shelter",
  #   str_detect(contents_split_rm,
  #              "wooden blocks") ~ "wooden blocks",
  #   .default = as.character(contents_split_rm)
  # ), .after = contents_split_rm) %>%

  
  
```

```{r}
summary(housing_df_3)
# start - old mean: median 28 days mean 80.35 | new median 28 & mean 73.18
# end - old mean: median 98 days mean 167.5 days | new median 98 & mean 162.8
# duration - old median 42 & median 85.635 | new median 40 & mean 90.287
```

```{r}
EE_only_df <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) # keeps 1 observation per group! 
```

```{r}
one_house_df <- housing_df_3 %>%
  group_by(animal_type, author_year, housing) %>%
  slice_head(n=1)
```

```{r}
# IC, SH, & EE
# excludes transgenic, Stress, ELS (MS), Cocaine, Injured & EPN (Pb exposure) etc
# keeps normal + Aging or duration, or saline/PBS, No MS stress (NS), PBS, WT, Intact
WT_ctrl_only <- housing_df_3 %>%
  filter(!str_detect(housing_condition, "Stress|Cocaine|TG|Injured|MS|EPN"))


# EE ONLY!!! (used for timeline plot!)
# excludes transgenic, Stress, ELS (MS), Cocaine, Injured & EPN (Pb exposure) etc
# keeps EE normal + Aging or duration, or saline/PBS, No MS stress (NS), PBS, WT, Intact
WT_ctrl_EE_only <- housing_df_3 %>%
  filter(!str_detect(housing_condition, "Stress|Cocaine|TG|Injured|MS|EPN")) %>%
  filter(housing == "EE")
```

## Housing Timeline plot test

-   <https://stackoverflow.com/questions/45245368/ggplot2-how-to-create-a-clustered-timeline>
    -   <https://ggplot2.tidyverse.org/reference/geom_segment.html> for timeline bits
-   <https://colorspace.r-forge.r-project.org/articles/hcl_palettes.html>
-   <https://en.wikipedia.org/wiki/Table_of_divisors>
-   <https://github.com/wilkelab/ggtext> & <https://r-graph-gallery.com/package/ggtext.html> - element_markdown() (using ggtext & glue packages) for specifying custom axis text labels - e.g. pink for females & blue for males.
    -   <https://stackoverflow.com/questions/72749018/color-axis-text-to-match-grouping-variable-in-ggplot>
-   OLD CODE DELETED
    -   geom_segment - y & yend= reorder(interaction(author_year, housing_condition), study_yr_by_dur, decreasing = TRUE),

```{r}
temp_colors <- c("#c90076", "#A80062", "#2986cc", "#1B5988", "grey15")

timeline_plot <- WT_ctrl_EE_only %>%
  
  # mutate(across(c(animal_type, housing, animal_sex), as.factor)) %>% # not needed?
  
  # MAKE NEW COMPUTED VARIABLES IN PREPARATION FOR PLOTTING 
  mutate(
  # MAKE appended author_year & housing_cond var (tp avoid using messy interaction())
    author_year_hc = paste0(author_year, " (", housing_condition, ")" ),
    
  # ORDERING BY YEAR & HOUSING DURATION! 
    # new composite variable for reorder() function below which only takes 1 var
    # it takes year year & adds a tiny contribution from during duration (dur/1000)
    # that way something with 2011 + 200 days ends up being higher 
    study_yr_by_dur = (year + (housing_duration_days/1000)), 
  
  # COLORING = 
  sex_colors = case_when(
    animal_sex == "female" ~ "#A80062", # female
    animal_sex == "male" ~ "#1B5988",  # male
    .default = "grey10"), # for NA / catch others
  .before = author
  ) %>%

  # COMPUTE VAR for element_markdown() (for custom axis text colors)
  mutate(
    #color = c("#A80062", "#1B5988", "grey15"), # see above instead! 
  names = glue("<i style='color:{sex_colors}'>**{author_year_hc}**</i>"),
  names = reorder(names, study_yr_by_dur, decreasing = TRUE)
         ) %>%
  
  ggplot(aes(
    color = author_year, # see mapping below 
    )) +
  
  # LINES for REFERENCE (e.g PND 0, 21, 1 year)
  geom_vline(xintercept = 0, linetype = "solid", # PND 0 line | birth
             color = "grey20", linewidth = .2) +
  geom_vline(xintercept = 21, linetype = "dashed", # PND 21 line | weaning
             color = "grey50", linewidth = .2) +
  geom_vline(xintercept = 365, linetype = "dotted", # PND 365 line | 1 year
             color = "grey50", linewidth = .2) +
  
  
  #TIMELINE SEGMENTS (SOLID)
  geom_segment(aes( #SOLID
    x = housing_start_day, # housing start date
    xend = housing_stop_day, # housing end date
    
    y = names,
    yend = names,
    ),
    linewidth = 2) +
    
    # # Gaps (for part time)
    # geom_segment(aes( # TIMELINE SEGMENTS
    # x = housing_start_day, # housing start date
    # xend = housing_stop_day, # housing end date
    # 
    # y = reorder(interaction(author_year, housing_condition),
    #                         study_yr_by_dur, # using com var made above!
    #                         decreasing = TRUE), # order by study year frm small2big
    # yend = reorder(interaction(author_year, housing_condition),
    #                            study_yr_by_dur, 
    #                            decreasing = TRUE)),
    # linewidth = 2) +
  
  scale_x_continuous(
    breaks = sort(c(-7, 0, 21, 365, 570, # specific ones i want
                    60, 120, 180, 240, 300, 420, 480, 540)), # by 30 
    # breaks=sort(c(0, 21, 365, 570,  # extra no. for labelling 
    #               seq(-7, 570, 34))), 
    #breaks=seq(-7,570,34), # seq(low,up,div)) 
    expand = c(0, 5), # minimal extra white space (0,0 too trimmed)
    name = "Postnatal Day (PND)") + 
  
  scale_color_discrete_qualitative(palette = "Dark 3") + # colorspace pkg
  # scale_color_discrete_divergingx(palette = "Temps") + # colorspace pkg
  # scale_color_discrete_qualitative(palette = "Harmonic") +
    
  # scale_color_manual(values = c("#A80062", "#1B5988", "grey15")) + 
  

  # FACET
  facet_wrap(#animal_type~animal_sex, 
             ~animal_type+animal_sex,
             # ncol =1,
             scales = "free_y", # don't plot all authors if no obs but x axis same 
             space = "free_y", # varies panel height according to no. authors
             labeller = labeller(
               animal_type = c(rats = "Rats", # capitilise rat = Rats
                             mice = "Mice",
                             pigs = "Pigs/Porcine")), 
             ) +
  # THEME  
  theme_bw() + 
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(), # custom ggtext color by animal_sex
  )

timeline_plot
```

------------------------------------------------------------------------

EE Contents

```{r}
EE_contents <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  mutate(enrichment_contents_split = str_split(enrichment_contents_list, "; "),
         .after = enrichment_contents_list) %>%
  tidyr::unnest(enrichment_contents_split) %>%
  count(enrichment_contents_split) 
```

```{r}
EE_running_wheel <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  count(running_wheel)

knitr::kable(EE_running_wheel) # 16/22 yes |includ Novati Saucer wheel
```

-   <https://cran.r-project.org/web/packages/ggwordcloud/vignettes/ggwordcloud.html>

-   <https://lepennec.github.io/ggwordcloud/>

```{r}
# EE_contents_wordcloud <- EE_contents %>%
ggplot(EE_contents, aes(label = enrichment_contents_split)) +
  geom_text_wordcloud() +
  theme_minimal()
```

-   <https://forum.posit.co/t/case-when-mutate-str-detect/124835>
-   <https://colorspace.r-forge.r-project.org/articles/ggplot2_color_scales.html>

```{r}
EE_contents_reshaped <- housing_df_3 %>%
  
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  
  mutate(enrichment_contents_split = str_split(
    enrichment_contents_list, ";"),
    .after = enrichment_contents_list) %>%
  
  tidyr::unnest(enrichment_contents_split) %>%
  mutate(contents_split = str_squish(enrichment_contents_split),
         .after = enrichment_contents_split) %>%
  
  mutate(contents_split_rm = str_remove_all(
    contents_split, "\\s*\\(.*?\\)"), # rm between brackets
    .after = contents_split) %>% 
  
  mutate(contents_split_clean = case_when(
    str_detect(contents_split_rm,
      pattern = "running wheel") ~ "running wheels",
    str_detect(contents_split_rm, "tunnel") ~ "tunnels",
    str_detect(contents_split_rm, "ladder") ~ "ladders",
    str_detect(contents_split_rm, "tube") ~ "tubes",
    str_detect(contents_split_rm, "toys") ~ "toys",
    str_detect(contents_split_rm, "ball") ~ "balls",
    str_detect(contents_split_rm, "bedding") ~ "bedding",
    str_detect(contents_split_rm, "house") ~ "house",
    str_detect(contents_split_rm, "shelter") ~ "shelter",
    str_detect(contents_split_rm,
               "wooden blocks") ~ "wooden blocks",
    .default = as.character(contents_split_rm)
  ), .after = contents_split_rm) %>%
  count(contents_split_clean) 

```

```{r}
ggplot(EE_contents_reshaped,
       aes(label = contents_split_clean,
           size = n)) +
  geom_text_wordcloud() +
  # geom_text_wordcloud_area() +
  # geom_text_wordcloud_area(rm_outside = TRUE) +
  scale_size_area(max_size = 16) +
  #scale_size_area(max_size = 50) +
  theme_minimal()
```

------------------------------------------------------------------------

### Males vs Females Study Count

```{r}
males_females_study <- housing_df_3 %>%
  group_by(author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>%
  count(animal_sex)

knitr::kable(males_females_study)
```

```{r}
animal_types_study <- housing_df_3 %>%
  group_by(author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>%
  count(animal_type)

knitr::kable(animal_types_study)
```

------------------------------------------------------------------------

Protein vs mRNA

```{r}
protein_mRNA <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>%
  count(h_exp_type)

knitr::kable(protein_mRNA)
```

proteomics

```{r}
proteomics_df <- housing_df_3 %>%
  filter(housing == "EE") %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  mutate(proteomics = ifelse(str_detect(h_method, "Proteomics"),
                             "proteomics",
                             "no proteomics")) %>%
  group_by(proteomics) %>%
  count(animal_type)
```

------------------------------------------------------------------------

Region

```{r}
regions_df <- housing_df_3 %>%
  filter(housing == "EE") %>%
  # filter(!author %in% c("Nithianantharajah", "Ickes", "Angelucci")) %>%
  group_by(animal_type, author_year) %>%
  slice_head(n = 1) %>% # keeps 1 observation per group! 
  ungroup() %>% 
  mutate(split_regions = str_split(h_regions, "; "), .after = h_regions) %>%
  tidyr::unnest(split_regions) %>%
  count(split_regions) %>%
  arrange(desc(n)) %>%
  mutate(total = sum(n)) %>%
  mutate(percent = round(n/total * 100, 1)) %>%
  mutate(percent_by_paper = round(n/23 * 100, 1)) 
  

knitr::kable(regions_df)
# 
```

```{r}
  # # group regions more broadly
  # mutate(cortex_hip = case_when(
  #   str_detect(split_regions, "Cortex") ~ "Cortex",
  #   str_detect(split_regions, "Hippocampus") ~ "Hippocampus",
  #   .default = as.character(split_regions)
  # ), .after = percent_by_paper) 
```

## gt

```{r}
housing_df_3 |> 
  # 
  # dplyr::select(c(animal_type,author_year, housing, animal_strain,
  #                 inbred_outbred, wt_tg, animal_sex,
  #                 cage_description, cage_dim_cm, no_per_cage, 
  #                 enrichment_contents_list, running_wheel,
  #                 procedure)) |>
  # ungroup() |>
  
  gt(
    groupname_col = "animal_type",
    # rowname_col = c("year", "author")
    rowname_col = "author_year"
  ) |>
  
  cols_label(
    # Gene_name = "Entry",
    # Entry.Name = "Name",
    # Full_name = "Protein Description",
    # # misc = "Arroyo's Identifiers"
    # `Protein description` = "Arroyo's Identifiers"
  ) |>
  
  tab_header(
    title = "Test",
    # subtitle = "Enriched vs. Barren: 56 DEG, 46 Up & 10 Down (adjp <=0.05), piggenemapped2ratgene (20 EE pigs & 20 BE pigs)", 
  ) |>
  
  # tab_style( 
  #   style = list(
  #     # cell_fill(color = "#F9E3D6"),
  #     cell_text(style = "italic")
  #     ),
  #   locations = cells_body(
  #     # columns = Gene_name,
  #     # rows = currency < 100
  #   )
  # ) |>
  
  tab_options(heading.title.font.size = 16.5,
              table.font.size=11.5,
              stub.font.weight = "bold",
              # stub.font.size = 13,
              row_group.font.weight = "bold",
              row_group.font.size = 14,
              column_labels.font.size = 12.5,
              column_labels.font.weight = "bold") 
 #|>
  
  # opt_stylize(style = 1, color = 'gray', add_row_striping = TRUE)
```
