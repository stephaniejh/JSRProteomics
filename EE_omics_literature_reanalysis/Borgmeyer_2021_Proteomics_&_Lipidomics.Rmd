---
title: "Borgmeyer_2021_Proteomics_&_Lipidomics"
author: "Stephanie Huang"
date: "2025_10_24"
output: html_document
---

## Re-analysis/Re-plotting of Borgmeyer et al., 2021

*in Cell Reports - "Multiomics of synaptic junctions reveals altered lipid metabolism and signaling following environmental enrichment"*

Analysis originally done in R_WD \> Proteomics \> EE_TMT \> v3_branched on 2025_10_24

ADD More details!

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# library(tidyverse) # ggplot, dplyr, etc
library(dplyr)
library(ggplot2)
library(stringr)
library(readr)
library(readxl) # for read_excel()
library(ggrepel) #  for geom_text_repel()
library(gt) # gt() tables
library(UniProt.ws) # for mapping | note conflicts with dplyr select
```

### Proteomics - Lipidomics - Table S7 - LFQ DEG MSstats - EE vs SH Hippocampus Synaptic Junctions

```{r}
hip_pro_file <- read_excel("input/Borgmeyer_2021_Table_S7_ProteinsLipids_EE_fig4a4b.xlsx",
                         sheet = "Proteins")
colnames(hip_pro_file)
str(hip_pro_file)
head(hip_pro_file)
```

```{r}

hippro_df <- hip_pro_file %>%
  rename("Protein" = "Protein/LipidName") %>%
  rename("Protein Name" = "ProteinName/Lipid Species") %>%
  mutate(EntryName = str_to_title(EntryName)) %>%
  arrange(pvalue)
  
```

<https://www.sthda.com/english/wiki/wiki.php?id_contents=7991> (text labels)

```{r fig.height=7, fig.width=10}
volcano_pv <- ggplot(hippro_df, 
                     aes(x =log(FoldChange), y = -log10(pvalue), label = EntryName)) +
  geom_point(aes(color = case_when(pvalue < 0.05 & log(FoldChange) > 0 ~ "Upregulated (p<0.05)",
                                   pvalue < 0.05 & log(FoldChange) < 0 ~ "Downregulated (p<0.05)",
                                   pvalue < 0.1 & log(FoldChange) > 0 ~ "Upregulated (p<0.1)",
                                   pvalue < 0.1 & log(FoldChange) < 0 ~ "Downregulated (p<0.1)",
                                   TRUE ~ "Not Significant")),
            alpha = 1, size = 3, shape = 1) +
  # facet_wrap(~ Label) +
  # xlim(-2,2) +
  scale_color_manual(values = c("firebrick3", 
                                "royalblue4", 
                                 "grey80"),
                     breaks = c("Upregulated (p<0.05)", 
                                "Downregulated (p<0.05)", 
                                "Not Significant"),
                     labels = c("Upregulated Proteins (p<0.05)", 
                                "Downregulated Proteins (p<0.05)", 
                                "Not Significant")) +
  
  geom_text_repel() +
  labs(title = "Borgmeyer 2021 SuppTable 7 - Significant Proteins (p<0.05) (24 Oct 2025)",
       subtitle = "Presented like Borgmeyer 2021 Fig4a or PhD Fig10A - log(FoldChange) by -log10(pvalue)",
       x = "Log(Fold Change)",
       y = "-Log10(p-value)",
       color = "Protein Regulation") +
  # geom_hline(yintercept = -log2(0.05), linetype = "dashed", linewidth = 0.2,  color = "grey30") +
  # annotate("text", x = .86, y = -log2(0.05), label = "Adj. p-value cutoff (0.05) \n",
  #          fontface = 'italic', size = 4, color = "grey10") +
  # geom_hline(yintercept = -log2(0.1), linetype = "dashed", linewidth = 0.2,  color = "grey50") +
  # annotate("text", x = .86, y = -log2(0.1), label = "Adj. p-value cutoff (0.1) \n",
  #          fontface = 'italic', size = 4, color = "grey30") +
  theme_bw() + 
  theme(legend.position = "bottom")



volcano_pv
```

```{r fig.height=7, fig.width=10}
volcano_adjpv <- ggplot(hippro_df, 
                     aes(x =log2FC, y = -log2(adj.pvalue), label = EntryName)) +
 geom_point(aes(color = case_when(adj.pvalue < 0.05 & log2FC > 0 ~ "Upregulated (adj. p<0.05)",
                                   adj.pvalue < 0.05 & log2FC < 0 ~ "Downregulated (adj. p<0.05)",
                                   adj.pvalue < 0.1 & log2FC > 0 ~ "Upregulated (adj. p<0.1)",
                                   adj.pvalue < 0.1 & log2FC < 0 ~ "Downregulated (adj. p<0.1)",
                                   TRUE ~ "Not Significant")),
            alpha = 1, size = 3, shape = 1) +
  # facet_wrap(~ Label) +
  # xlim(-1,1) +
  scale_color_manual(values = c("firebrick3", 
                                "royalblue4", 
                                "lightpink1", 
                                "lightblue3" , 
                                 "grey80"),
                     breaks = c("Upregulated (adj. p<0.05)", 
                                "Downregulated (adj. p<0.05)", 
                                "Upregulated (adj. p<0.1)", 
                                "Downregulated (adj. p<0.1)", 
                                "Not Significant"),
                     labels = c("Upregulated Proteins (up to adj. p<0.05)", 
                                "Downregulated Proteins (up to adj. p<0.05)", 
                                "Upregulated Proteins (up to adj. p<0.1)", 
                                "Downregulated Proteins (up to adj. p<0.1)" , 
                                "Not Significant")) +
  
  geom_text_repel() +
  labs(title = "Borgmeyer 2021 SuppTable 7 - Significant Proteins (p<0.05) (24 Oct 2025)",
       subtitle = "Presented like MSstats and my data log2FC & -log2(adj.pvalue)",
       x = "log2FC",
       y = "-Log2 (adjusted p-value)",
       color = "Protein Regulation") +
  # geom_hline(yintercept = -log2(0.05), linetype = "dashed", linewidth = 0.2,  color = "grey30") +
  # annotate("text", x = .86, y = -log2(0.05), label = "Adj. p-value cutoff (0.05) \n",
  #          fontface = 'italic', size = 4, color = "grey10") +
  # geom_hline(yintercept = -log2(0.1), linetype = "dashed", linewidth = 0.2,  color = "grey50") +
  # annotate("text", x = .86, y = -log2(0.1), label = "Adj. p-value cutoff (0.1) \n",
  #          fontface = 'italic', size = 4, color = "grey30") +
  theme_bw() + 
  theme(legend.position = "bottom")



volcano_adjpv
```

-   <https://gt.rstudio.com/reference/gt.html>

-   <https://gt.rstudio.com/reference/fmt_number.html>

```{r}
hippro_df |>
  gt(
    groupname_col = "Regulation"
    ) |>
  fmt_number(decimals = 3) |>
  # data_color(columns = "Regulation") +
  tab_options(table.font.size=12) 
  # tab_style(
  #   style = cell_fill(color = "lightblue"),
  #   locations = cells_body(rows = log2FC < 0)
  # )
  
```

### Lipidomics - Table S7 - LFQ DEG MSstats - EE vs SH Hippocampus Synaptic Junctions

To add

------------------------------------------------------------------------

## Map 2 uniprot + making lit review table.

Pull uniprot data to map gene ids

See if mice ids match rats \| use predownloaded rda from Uniprot.Ws (otherwise takes forever - see uniprot script).

```{r}
load(file = "input/mouse_ref_proteome_2025_12_13_54864x295.rda")
load(file = "input/rat_ref_proteome_2025_12_13_51872x295.rda")
```

```{r}
mouse_ref <- mouse_ref_proteome_2025_12_13 %>% 

```

```{r}
# cols I want from uniprot
# my_cols <- c('accession', 'id', 'gene_names', 'gene_primary', 'protein_name',
#              	'xref_proteomes', '	reviewed', 'annotation_score', 'protein_existence',
#              'length', 'organism_name', 'keyword', 'keywordid', 'protein_families',
#              'cc_function', 'cc_developmental_stage', 'cc_tissue_specificity',
#              'xref_geneid')

#colnames(mouse_ref_proteome_2025_12_13)

my_cols <- c("Entry", "Entry.Name", "Protein.names", "Gene.Names..primary.",
             "Gene.Names", "Gene.Names..synonym.",  "Annotation", "Reviewed",
             "Protein.existence", "Protein.families", "Length", "Organism",
             "Keywords", "Keyword.ID", "Function..CC.", "Miscellaneous..CC.", "Pathway",
             "GeneID", "Gene.Ontology..GO.", "Gene.Ontology..cellular.component.",
             "Gene.Ontology..molecular.function.", "Gene.Ontology..biological.process.",
             "Gene.Ontology.IDs", "KEGG", "Reactome", "STRING",
             "Entry.version", "Date.of.creation", "Date.of.last.modification",
             "Date.of.last.sequence.modification"
             )

```

```{r}
mouse_ref <- mouse_ref_proteome_2025_12_13 %>% 
  dplyr::select(all_of(my_cols)) %>%
  mutate(existence_ranking = case_when( # ranking level of evidence
    Protein.existence == "Evidence at protein level" ~ 5,
    Protein.existence == "Evidence at transcript level" ~ 4,
    Protein.existence == "Inferred from homology" ~ 3, 
    Protein.existence == "Predicted" ~ 2, 
    Protein.existence == "Uncertain" ~ 1
    ), .after = Protein.existence)
```

```{r}
# https://www.uniprot.org/help/protein_existence - see rankings 
unique(rat_ref_proteome_2025_12_13$Protein.existence) 


rat_ref <- rat_ref_proteome_2025_12_13 %>% 
  dplyr::select(all_of(my_cols)) %>%
  mutate(existence_ranking = case_when( # ranking level of evidence
    Protein.existence == "Evidence at protein level" ~ 5,
    Protein.existence == "Evidence at transcript level" ~ 4,
    Protein.existence == "Inferred from homology" ~ 3, 
    Protein.existence == "Predicted" ~ 2, 
    Protein.existence == "Uncertain" ~ 1
    ), .after = Protein.existence) #%>%
  #mutate(occupied = rowSums(!is.na(rat_ref))) # some blanks not recognised
  #mutate(occupied = rowSums(!= "")) # recognises blanks better but still some na
```

```{r}
#mapped additional uniprot information by provided uniprot accession
# all 178 mapped 1 to 1
hip_mouse_mapped <- left_join(hippro_df, mouse_ref,
                              by = join_by(Protein == Entry))

```

```{r}
# NVM not a good method = too many unmapped
# try matching protein names to protein names 
rat_proteins_hip <- left_join(hippro_df, rat_ref,
                              by = join_by(`Protein Name` == Protein.names))

# 136 NAs
sum(is.na(rat_proteins_hip$Entry))
```

-   <https://stackoverflow.com/questions/44759180/filter-by-multiple-patterns-with-filter-and-str-detect>

```{r}
# make vector of gene names from Borgmeyer
genes_hip <- hippro_df$EntryName

# then filter by matching to any of in the uniprot gene.names column (multiple entries)
rat_genes_hip <- rat_ref %>%
  filter(str_detect(Gene.Names,
                    pattern = paste(genes_hip, collapse = '|'))) 

length(unique(rat_genes_hip$Gene.Names..primary.)) # 115 primary unique gene entries 
# BUT NOTE - some are falsely picked up with str_detect e.g. syt1 will get sty11 too.
# so need to filter & check further!

mean(rat_genes_hip$Annotation) # 2.69
```

```{r}
to_check <- rat_genes_hip %>%
  filter(!(Gene.Names..primary. %in% genes_hip))
```

```{r}
rat_hip_map_1 <- left_join(hippro_df, rat_ref, #369 entries when mapped
                           by = join_by(EntryName == Gene.Names..primary.)) %>%
  
  group_by(EntryName) %>% # 178 from Borgmeyer
  filter(if(any(Reviewed == "reviewed", na.rm = TRUE)) {
    Reviewed == "reviewed"
  } else {TRUE}) %>%  # 205
  slice_max(Annotation, n = 1) %>% # 193 
  slice_max(existence_ranking, n = 1) #%>% # 189
  #slice_max(occupied, n = 1) # 187
  

length(unique(rat_hip_map_1$EntryName))
```

```{r}
# see duplicates
rat_hip_map_1 %>%
   count(EntryName) %>%
   arrange(desc(n))
```

```{r}
rat_hip_map_1_na <- rat_hip_map_1 %>%
  filter(is.na(Entry))
```

```{r}
intersect(rat_hip_map_1_na$EntryName, rat_genes_hip$Gene.Names..synonym.)
```

```{r}
rat_genes_hip_split <- rat_genes_hip %>%
  mutate(synonyms = str_split(Gene.Names..synonym., " ")) %>%  # now should be , sep
  tidyr::unnest(synonyms)
```

```{r}
rat_hip_map_2 <- hippro_df %>%
  filter(EntryName %in% rat_hip_map_1_na$EntryName) %>%
  left_join(rat_genes_hip_split,
            by = join_by(EntryName == synonyms)) # works recovers 9 more 
```

------------------------------------------------------------------------

```{r}
rat_mouse <- bind_rows(list(rat_ref = rat_ref, mouse_ref = mouse_ref), .id = "df")
```

```{r}
synaptophysin <- rat_mouse %>%
  filter(Protein.names == "Synaptophysin") # interesting - the gene names are the same here!!! 

# TO DO - map from Borgmeyer uniprot accession, then take primary gene names & map to rat. Should be higher that way. 
```

------------------------------------------------------------------------

### Lit review table

```{r}
# colnames(com_df_w_ids) # check col names 

# new v2 df (v5 exp ) - ordered properly to match lit review
lit_re <- com_df_w_ids %>%
  mutate(
    Year = 2021,
    Author = 'Borgmeyer',
    Animal = 'Mice',
    Condition = "Fraction - Synaptic Junction",
    Region = 'Hippocampus',
    Whole = 'No',
    Exp_type = 'Protein',
    Method = 'PROTEOMICS_LCMS_LFQ_OS',
    Used_name = `Protein Name`,
    Mod = " ",
    Mod_type = " ",
    Gene_name = `Gene Names (primary)`,
    Comparison = 2,
    In_EE = Direction,
    Fold_change = avg_ratio,
    Arrows = ifelse(Direction == 'Up', '+', '-'),
    Significant = ifelse(`Control vs. enriched (t-test)` <= 0.05, 'yes', 'no'),
    pvalue = `Control vs. enriched (t-test)`,
    N_tested = 6,
    Stats_adj = ' ',
    Note = ' ',
    Full_name = `Protein names`,
    Uniprot_rat_accession = Entry,
    Uniprot_entry_name = `Entry Name`,
    Uniprot_link = ifelse(!is.na(Entry),
                          paste0('https://www.uniprot.org/uniprotkb/', Entry,'/entry'),
                          ' '),
    Wikipedia_link = ifelse(!is.na(Entry),
                            paste0('https://en.wikipedia.org/wiki/',
                                   `Gene Names (primary)`),
                            ' '),
    Curation_method = ifelse(!is.na(Entry), 'auto - ncbi_gi-to-uniprot', 'manual'),
    Class_group = Class,
    Other_link = ' ',
    Other_comments = 'misc shows combined provided info from their df',
    misc = paste0(Protein, '_')
  )
```
