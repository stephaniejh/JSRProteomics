---
title: "BioIn_2026_01_v3.4.2_ClusterProfiler"
author: "Stephanie Huang"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ClusterProfiler BioIn vis - 1pspg v3.2.2 EE x Age t1

*for MSstatsTMT 1pspg v3.2.2 EE x Age t1 -(defaults) with B1 129N removed (TMT channel with too much loaded)*

This script is for running the GSEA - uses for loops.

This is a temporary script is for visualization of the results

Outputs

1.  2025_12_31

2.  

## Set up

### Packages

```{r}
# # Install if needed 
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# 
# BiocManager::install("clusterProfiler")
# BiocManager::install("msigdbr")
# BiocManager::install("org.Rn.eg.db")
# BiocManager::install("enrichplot")
# BiocManager::install("pathview")
```

```{r}
# Load Packages 
library(tidyverse) # for dplyr, ggplot, stringr, readr etc 
library(clusterProfiler) #GSEA includes gsea, enrichplot etc.
library(org.Rn.eg.db) # Rat genome anno pack- incl. AnnotationDbi
library(msigdbr) # MSigDB gene sets
library(enrichplot) # for dotplot()
library(ggridges) # for ridgeplot()
library(pathview) # pathview() - Kegg pathway visualisation
```

### Import data

Load the mapped comparisons output generated from

```{r}
# mapped_comp_v3.2.2_EExAge_t1
load("input/protein_lists/2025_12_31_1pspg_v3.2.2_t1_EExAge_mapped_comp.rda")

df <- mapped_comp_v3.2.2_EExAge_t1
```

lil checks

```{r}
# lil checks
head(df) # peak
str(df) # structure | 7746 x 9
colnames(df) # column names

# lil checks (bit messy)
unique(df$issue) # if = na in issue column then good. if not exclude
check_1 <- df %>% filter(str_detect(log2FC, "Inf")) # 5 inf 
check_2 <- df %>% filter(str_detect(Protein, "Cont")) # 0 (since already removed)
unique(df$Label) 
length(unique(df$Label)) #8
```

### **Clean up df & rename**

```{r}
protein_comp <- df %>%
  filter(is.na(issue)) %>% # keeps rows with issue == na (so comparisons that are ok)
  filter(!str_detect(log2FC, "Inf")) # remove infinity/missing fold change values

# check 
head(protein_comp) 
colnames(protein_comp)

```

```{r}
# # check 
# unique(df$Label) 
# # don't want "HxA_EE_YNG_vs_SH_OLD" "HxA_EE_OLD_vs_SH_YNG", so just do manually 
# 
# # VECTOR for labels (contrasts from MSstatsTMT analysis)
# label_names <- c("H_EE_vs_SH", "A_YNG_vs_OLD",
#                  "HxA_EE_YNG_vs_EE_OLD", "HxA_SH_YNG_vs_SH_OLD",
#                  "HxA_EE_YNG_vs_SH_YNG", "HxA_EE_OLD_vs_SH_OLD")

label_names <- unique(protein_comp$Label)

# # CONTAINER - EMPTY VECTOR
# gsea_KEGG_results_list <- vector(mode = "list")
```

------------------------------------------------------------------------

## Testing conversion of bitr (extra)

From FASTA - uniprot uniprot acc

<https://yulab-smu.top/biomedical-knowledge-mining-book/utilities.html#sec-id-convert>

```{r}
protein_comp_uni_prot <- unique(protein_comp$Protein) # 8048 
protein_comp_uni_gene <- unique(protein_comp$gene) # 8014
```

```{r}
# Gene name 2 EntrezID | .0339 x 8104 = 272 ish
bitr_gn_2_entrez <- bitr(protein_comp_uni_gene,
                         fromType = "SYMBOL",
                         toType = "ENTREZID",
                         OrgDb = "org.Rn.eg.db") #3.39% failed to map... better
# 'select()' returned 1:1 mapping between keys and columns
#Warning message: In bitr(protein_comp_uni_gene, fromType = "SYMBOL", toType = "ENTREZID",:  3.39% of input gene IDs are fail to map...


# Seems gn 2 entrez is the superior option. 
length(unique(bitr_gn_2_entrez$SYMBOL)) # 7742
length(unique(bitr_gn_2_entrez$ENTREZID)) # 7742

# length(unique(bitr_up_2_entrez$UNIPROT)) # 7325
# length(unique(bitr_up_2_entrez$ENTREZID)) # 7392
```

```{r}
protein_comp_entrez <- left_join(protein_comp, bitr_gn_2_entrez,
                                 by = join_by(gene == SYMBOL)) %>%
  filter(!is.na(ENTREZID)) # remove non mapped - 64384 to 61952 
```

old stuff

------------------------------------------------------------------------

```{r}
# # load gsea results from v3.4.2. 31 dec & 01 jan 
# # GSEA KEGG - 2025_12_31 - gseKEGG - keytype Uniprot
# load("output/2025_12_31_KEGG_gsea_EExAge_cp_v3.4.2_msstats_v3.2.2_t1.rda")
# # # GSEA GO - 2025_12_31 / gseGO (keytype Uniprot) | takes forever....
# # load("output/2025_12_31_GO_gsea_EExAge_cp_v3.4.2_msstats_v3.2.2_t1.rda")
# # ~ ~ ~ ~ ~~
# # GSEA Msigdb Hallmarks Collection  / gsea key type ncbi entrez - 2026_01_01
# load("output/2026_01_01_gsea_msig_Hallmark_EExAge_cpv3.4.2_mssv3.2.2_t1.rda")
# # GSEA Kegg REDO gsekegg / entrez - 2026_01_01
# load("output/2026_01_01_KEGG_gsea_EExAge_cpv3.4.2t2_mssv3.2.2t1.rda")

```

```{r}
load("output/2026_01_12_KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3.rda") # KEGG
load("output/2026_01_12_GO_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t2.rda") # GO

# MSIGDB
load("output/2026_01_12_gsea_msig_Hallmark_EExAge_mssv3.2.2_t1_cpv3.4.2_t2.rda") 
load("output/2026_01_12_gsea_msig_C8_ct_EExAge_mssv3.2.2_t1_cpv3.4.2_t2.rda")
```


## print KEGG sign dot plots 

```{r fig.height=12, fig.width=11}
print(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$dotplots_sign) # kegg


# print(gsea_msig_Hmrk_EExAge_cp3.4.2_mss3.2.2_t1$dotplots) # msigdb hallmarks entrez
# print(KEGG_gsea_EExAge_cpv3.4.2t2_mssv3.2.2t1$dotplots) # kegg entrez
```

## print GO sign dot plots 
```{r fig.height=12, fig.width=11}
print(GO_gsea_EExAge_msstats_v3.2.2_t1_cp_v3.4.2_t2$dotplots_sign)
```

## print Msigdb Hallmarks sign dot plots 
```{r fig.height=12, fig.width=11}
print(gsea_msig_Hmrk_EExAge_mss3.2.2_t1_cp3.4.2_t2$dotplots_sign)
```

## print Msigdb C8 CellTypes sign dot plots 
```{r fig.height=12, fig.width=11}
print(gsea_msig_C8_ct_EExAge_mss3.2.2_t1_cp3.4.2_t2$dotplots_sign)
```


