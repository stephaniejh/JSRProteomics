---
title: "BioIn_2026_01_v3.4.2_ClusterProfiler_EExAge_vis_v2"
author: "Stephanie Huang"
date: "2026-01-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# [BioIn_2026_01_v3.4.2_ClusterProfiler_EExAge_vis_v2]{.underline}

# Setup

### Load Packages

```{r}
set.seed(123) # for reproducibility

# Load Packages 
library(tidyverse) # for dplyr, ggplot, stringr, readr, purrr, tibble, tidyr etc 
library(readxl)
library(clusterProfiler) #GSEA includes gsea, enrichplot etc.
library(GOSemSim) # needed for simplify or now?
library(org.Rn.eg.db) # Rat genome anno pack- incl. AnnotationDbi
library(msigdbr) # MSigDB gene sets
library(enrichplot) # for dotplot()
library(ggridges) # for ridgeplot()
library(pathview) # pathview() - Kegg pathway visualisation

library(gganatogram) # gganatogram CO GG
library(drawCell) # drawing GO CC - SwissBioPics 
library(htmlwidgets) #
library(webshot2)

library(paletteer) # colors
library(colorspace) # colors
library(cowplot) # plot_grid

library(readxl)
library(writexl) # for excel tab export
```

### Load Data

```{r}
# #READ IN DATA
# KEGG
load("output/gsea_results/2026_01_12_KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3.rda") 

# GO simplified (was prev made in this script)
load("output/gsea_results/2026_01_24_GO_gsea_EExAge_cp_v3.4.2_t2_simplified.rda")

# MSIGDB
load("output/gsea_results/2026_01_12_gsea_msig_Hallmark_EExAge_mssv3.2.2_t1_cpv3.4.2_t2.rda")
```

```{r}
up_subcell_raw <- read_excel(
  "input/UP_anno/UP_subcellular_locations_all_2026_01_23.xlsx")
```

------------------------------------------------------------------------

# Wrangling

### Map nested .rda to master dfs

```{r}
# Map KEGG to a MASTER DF 
KEGG_tibs_df <- map_dfr(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results_tib,
                        as.data.frame,
                        .id = "Label") 

# MAP Msigdb Hallmarks to masterdf 
HM_tibs_df <- map_dfr(gsea_msig_Hmrk_EExAge_mss3.2.2_t1_cp3.4.2_t2$gsea_results_tib,
                        as.data.frame,
                        .id = "Label")


# MAP GO Simplified (nested nested) to single df
GO_sim_tibs_df <- map_dfr(
  GO_gsea_EExAge_cp_v3.4.2_t2_simplified$sim_GO_res_tib,
  ~map_dfr(.x, as_tibble, .id = "GO"),
  .id = "Label")
```

```{r}
my_levels = c("H_EE_vs_SH",
              "HxA_EE_YNG_vs_SH_YNG",
              "HxA_EE_OLD_vs_SH_OLD",
              "A_YNG_vs_OLD", 
              "HxA_EE_YNG_vs_EE_OLD",
              "HxA_SH_YNG_vs_SH_OLD"
)


# KEGG 6 ORD
KEGG_tibs_df_6 <- KEGG_tibs_df %>%
  filter(!(Label %in% c("HxA_EE_OLD_vs_SH_YNG", "HxA_EE_YNG_vs_SH_OLD"))) 

KEGG_tibs_df_6$Label <- factor(KEGG_tibs_df_6$Label,
                                  levels = my_levels)

# GO 6 ORD
GO_sim_tibs_df_6 <- GO_sim_tibs_df  %>%
  filter(!(Label %in% c("HxA_EE_OLD_vs_SH_YNG", "HxA_EE_YNG_vs_SH_OLD"))) 

GO_sim_tibs_df_6$Label <- factor(GO_sim_tibs_df_6$Label,
                                  levels = my_levels)


# # MSIGDB | "HxA_EE_OLD_vs_SH_OLD",
# 
# HM_tibs_df_6 <- HM_tibs_df  %>%
#   filter(!(Label %in% c("HxA_EE_OLD_vs_SH_YNG", "HxA_EE_YNG_vs_SH_OLD")))
# 
# HM_tibs_df_6$Label <- factor(HM_tibs_df$Label,
#                              levels = c("H_EE_vs_SH",
#                                         "HxA_EE_YNG_vs_SH_YNG",
#                                         # "HxA_EE_OLD_vs_SH_OLD",
#                                         "A_YNG_vs_OLD",
#                                         "HxA_EE_YNG_vs_EE_OLD",
#                                         "HxA_SH_YNG_vs_SH_OLD"))
# 
# # error idk
# #Error in `$<-.data.frame`(`*tmp*`, Label, value = c(1L, 1L, 1L, 1L, 1L,  :
# #  replacement has 25 rows, data has 19
```

```{r}
# note alot here don't have GOID anyway
colnames(up_subcell_raw)
str(up_subcell_raw)

up_subcell <- up_subcell_raw %>%

  tidyr::separate_wider_regex( # use this instead!
    `Gene Ontologies`,
    patterns = c(go_id = "GO:\\d+", # matches GO:0002079:
                 ":",
                 go_term = ".*"), # matches any char at end of string
    cols_remove = FALSE) %>%
  mutate(subcell_ID = str_remove(`Subcellular location ID`, "-"),
         .after = `Subcellular location ID`)

# note "SL-0181" rather than "SL0181" - sometimes varies?
```

```{r}
KEGG_counts <- KEGG_tibs_df %>%
  count(Label)
```

------------------------------------------------------------------------

## Functions

### Lolliplot

```{r}
lolliplot <- function(data,
                      x_1 = Description, 
                      x_2 = NES, 
                      y = NES, 
                      fill = NES,
                      alpha = p.adjust,
                      facet_formula = ~Label,
                      size = setSize,
                      subtitle = NULL,
                      legend_pos = "none") {
  
  lol <- ggplot(data,
                aes(x = reorder({{x_1}},{{x_2}}),
                    y = {{y}},
                    fill = {{fill}}
                    )) +
    
    geom_segment(aes(x = {{x_1}},
                     yend = {{y}}, y = 0,
                     alpha = {{alpha}}
                     )) +
    
   geom_point(aes(alpha = {{alpha}},
                  size = {{size}}),
             shape = 21) +
    scale_alpha(range = c(.9,.3)) + # rev alpha so darker = more sig
    geom_hline(yintercept = 0, color = 'grey20', linewidth = 0.1) +
    scale_color_manual(breaks = c("Up", "Down"),
                     # values = c("#dc322f", "#268bd2"),
                     guide = 'none') + 
   scale_size_continuous(range = c(3,9)) + # map size oflolly (set size)
    
    # scale_fill_continuous_diverging("Blue-Red 3") + # colorspace
    scale_fill_continuous_diverging("Blue-Red 2") +
  
    ylim(-4,4)+
  
    labs(subtitle = subtitle,
       y = 'NES' ) +
    
    coord_flip() + #fliptheplot
    facet_wrap(facet_formula,
             space = 'free_x') +
    theme_bw() +
    theme(
    axis.text.x = element_text(angle = 90, hjust = 1, color = "grey15",
                               vjust = 0.5, # 90, hj1 t/R, vj.5 cent
                               size = 9.5, face = 'italic'), 
    axis.text.y = element_text(hjust = 1, color = "grey20",
                               size = 9.5, face = 'italic'), 
    axis.title.y = element_blank(),
    strip.text = element_text(size = 8.5),
    legend.position = legend_pos) 
    
}
```

```{r}
HM_lol <- lolliplot(HM_tibs_df_6, subtitle = "MSigDB Hallmarks", legend_pos = "bottom")
HM_lol

```

### KEGG lolliplots

```{r}
# KEGG ALL 6
KEGG_lol_f6 <- lolliplot(KEGG_tibs_df_6,
                      title = "KEGG", legend_pos = "bottom")
KEGG_lol_f6 
# exp - 2026_01_31_EExAge_6_comps_KEGG_lolli_v1 12 x 12 
```

#### EE KEGG lolli

```{r}
# KEGG 3 EE
KEGG_tibs_EE_3 <- KEGG_tibs_df_6 %>%
  filter(Label %in% c("H_EE_vs_SH","HxA_EE_YNG_vs_SH_YNG","HxA_EE_OLD_vs_SH_OLD")) %>%
  lolliplot(subtitle = "KEGG GSEA - Housing")

KEGG_tibs_EE_3 
# exp - 2026_01_31_EE_3_comps_KEGG_lolli_v1 - 9 x 12
```

#### Pathview EE - nvm ignore for now. just use old

-   <https://www.bioconductor.org/packages/devel/bioc/vignettes/pathview/inst/doc/pathview.pdf>

#### Running Scores

<https://yulab-smu.top/biomedical-knowledge-mining-book/enrichplot.html#running-score-and-preranked-list-of-gsea-result>

```{r}
#head(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results$H_EE_vs_SH$Description, 20)

# 10 = Reterograde Endo cannm, 12 - synaptic vesicle, 20 neuroactive
# gseaplot2(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results$H_EE_vs_SH,
#           geneSetID = c(10,12, 20))


p1 <- gseaplot2(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results$H_EE_vs_SH,
                geneSetID = c(10,12, 20, 6:8, 1), subplots = 1:2,
                color = c("#D3F2A3FF", "#E17C05FF", "#586e75", "#F3AD6AFF",
                          "#F1B6DAFF", "#D43F23" ,"#CF597EFF"),
                title = "KEGG - EE vs SH (all)")

#head(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results$HxA_EE_YNG_vs_SH_YNG$Description, 50)
p2 <- gseaplot2(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results$HxA_EE_YNG_vs_SH_YNG,
          geneSetID = c(1, 9, 10, 22, 27, 31, 32, 46, 47), subplots = 1:2,
          color = c("#2896B5", "#589D4C", "#A054A3", "#E17C05FF",
                   "#F1B6DAFF", "#586e75", "#F3AD6AFF", "#D43F23" ,"#CF597EFF"),
          title = "KEGG - EE vs SH (young)")



p3 <- gseaplot2(KEGG_gsea_EExAge_mssv3.2.2t1_cpv3.4.2t3$kegg_results$HxA_EE_OLD_vs_SH_OLD,
          geneSetID = c(1,3), subplots = 1:2,
          color = c("#586e75", "#CF597EFF"), 
          title = "KEGG - EE vs SH (old)")


plot_list(p1, p2, p3, ncol = 1)
```

# go plots

```{r}
GO_sim_tibs_df_6 <- GO_sim_tibs_df %>%
  filter(!(Label %in% c("HxA_EE_OLD_vs_SH_YNG", "HxA_EE_YNG_vs_SH_OLD"))) 

GO_sim_tibs_df_6$Label <- factor(GO_sim_tibs_df_6$Label,
                                  levels = c("H_EE_vs_SH",
                                             "HxA_EE_YNG_vs_SH_YNG",
                                             "HxA_EE_OLD_vs_SH_OLD",
                                             "A_YNG_vs_OLD", 
                                             "HxA_EE_YNG_vs_EE_OLD",
                                             "HxA_SH_YNG_vs_SH_OLD"))


GO_sim_lol_6_CC <-   GO_sim_tibs_df_6 %>%
  filter(GO == "CC") %>%
  lolliplot()
GO_sim_lol_6_CC
```

```{r}
GO_sim_lol_3_EE <-   GO_sim_tibs_df_6 %>%
  filter(Label %in% c("H_EE_vs_SH","HxA_EE_YNG_vs_SH_YNG","HxA_EE_OLD_vs_SH_OLD")) %>%
  # filter(GO == "CC") %>% # Swi
  filter(p.adjust < 0.03) %>% # cut of for BP so ~136 
  filter(GO == "BP") %>% # Swi
  lolliplot(subtitle = "GO BP - Housing")


GO_sim_lol_3_EE


# exp - 2026_01_31_EE_3_comps_GO_CC_sim_lolli_v1 - 9 x 12.75
# exp - 2026_01_31_EE_3_comps_GO_MF_sim_lolli_v1 - 9.25 x 10 | font 

# BP too long! 
# BP  2026_01_31_EE_3_comps_GO_BP_sim_lolli_adjp_03_trim_v1 - 9 x 13

```

\# exp - 2026_01_31_EE_3_comps_GO_CC_sim_lolli_v1

```{r}
GO_sim_EE_CC_map <- GO_sim_tibs_df_6 %>%
  filter(Label %in% c("H_EE_vs_SH","HxA_EE_YNG_vs_SH_YNG","HxA_EE_OLD_vs_SH_OLD")) %>%
  filter(GO == "CC") %>% 
  left_join(up_subcell, by = join_by(ID == go_id))

#colnames(GO_sim_EE_CC_map)
unique(GO_sim_EE_CC_map$`Is part of`)
```

```{r}
neuron_map_EE_cell_comp <- drawCell::drawCell(
  organism_identifier = "6072",
  list_sl_colors = list(
    "SL0191" = "#586F9AFF", # nucleus
    "SL0173" = "#CF597EFF", # mitochondrion
    "SL0132" = "#39B185FF", # golgi apparatus
    "SL0095" = "#3B738FFF", # Ebdoplasmic reticulum
    "SL0101" = "#E17C05FF", # Endosome
    "SL0197" = "#FEE08BFF", # Perikaryon / soma
    "SL0154" = "#A8DBD9FF", # Lipid Droplet
    "SL0158" = "#7CAF71FF", # Lysosome
    "SL0091" = "#E6F5D0FF", # Cytosol
    "SL0090" = "#E6AB02FF", # Cytoskeleton
    
    "SL0279" = "#D3F2A3FF", # axon
    "SL0288" = "#97E196FF", # growth cone
    "SL0176" = "#F1B6DAFF", # Myelin membrane
    "SL0284" = "#F9C7B8FF", # dendrite
    "SL0258" = "#F3AD6AFF", # synapse
    "SL0297" = "#586F9AFF", # post synaptic density?
    "SL0219" = "#DB7B80FF", # postsynaptic cell mem 
    "SL0284" = "#EE4D5AFF", # Dendritc Spine
    "SL0285" = "#F46D43FF", # Dendritc Spine mem
    "SL0530" = "#68ABB8FF", # Spine Apparatu mem
    
    "SL0222" = "#D1EEEAFF", # presynaptic cell mem 
    "SL0519" = "#EDAD08FF", # presyn active zone
    "SL0259" = "#4C90B4FF", # Synaptic Vesicle
    "SL0260" = "#8FBFD7FF", # Synap Vesic Mem
    "SL0039" = "#DC3977FF" # Cell membrane
  ),
  width = 2000,
  height = 500
)

neuron_map_2026_01_28

# saveWidget(neuron_map_2026_01_28, "neuron_map_2026_01_28.html")
# 
# webshot(url = "neuron_map_2026_01_28.html",
#         file = "neuron_map_2026_01_28.pdf",
#         # file = "temp.png",
#         #vwidth = 600,
#         #vheight = 300,
#         delay = 10 # adding delay fixes problem (slow! otherwise blanks)
#         )


```
